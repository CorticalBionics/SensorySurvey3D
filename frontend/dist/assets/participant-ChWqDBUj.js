import{S as ie,C as E,a as le,b as ce,p as ue,u as O,c as g,o as y,d as se,V as P,e as ae}from"./common-CfgGtn2R.js";/* empty css                     */document.title="Participant - SensorySurvey3D";var l,n,S,B,w,M,N;const x="/participant-ws";var r;function Y(){r=new WebSocket(x),r.onopen=function(){console.log("Socket connected!"),N=setInterval(function(){n.updateSurveyOnServer(r)},1e3)},r.onmessage=function(e){const t=JSON.parse(e.data);switch(t.type){case"survey":de(t.survey);break;case"submitResponse":t.success?(n.clearSurvey(),S.clear(),l.unloadCurrentMesh(),l.orbMesh.visible=!1,Q(t.success)):M?Q(t.success):alert("Received submitSuccess without making a submission!");break}},r.onclose=function(){console.log("Connection to websocket @ ",x," closed. Attempting reconnection in 1 second."),clearInterval(N),setTimeout(function(){Y()},1e3)},r.onerror=function(e){console.error("Websocket error: ",e.message),r.close()}}function h(e){var i=document.getElementById("sidebar").querySelectorAll("button");for(let o=0;o<i.length;o++)i[o].disabled=!e,e?i[o].style.pointerEvents="auto":i[o].style.pointerEvents="none"}function T(e){document.getElementById("undoButton").disabled=!e,document.getElementById("redoButton").disabled=!e}function m(e,t,i){const o=document.getElementById("alertTab");o.innerHTML="";const c=document.createElement("p");c.style.textAlign="center",c.innerHTML=e;const u=document.createElement("div");for(let d=0;d<t.length;d++){const s=t[d],a=document.createElement("button");a.innerHTML=s,a.onpointerup=i[d],u.appendChild(a)}o.appendChild(c),o.appendChild(u),y("alertTab")}function H(e,t=null,i=null,o=null){l.orbMesh.visible=!1,document.getElementById("modelSelect").disabled=!0,l.replaceCurrentMesh(e,t,i).then((function(){l.orbMesh.visible=!1,B.reset(),document.getElementById("modelSelect").disabled=!1,o&&o.x?(l.orbMesh.position.copy(new P(o.x,o.y,o.z)),l.orbMesh.visible=!0):(l.orbMesh.position.copy(new P(0,0,0)),l.orbMesh.visible=!1)}).bind(o))}function L(){T(!0),y("fieldTab")}function b(){T(!1),y("qualifyTab")}function p(){document.getElementById("orbitButton").dispatchEvent(new Event("pointerup")),n.survey.renameFields();let e=n.survey.projectedFields.indexOf(n.currentField);S.update(n.survey,e),T(!1),y("listTab")}function A(e,t){e.innerHTML="";for(let i=0;i<t.length;i++){const o=document.createElement("option");o.innerHTML=t[i].charAt(0).toUpperCase()+t[i].slice(1),o.value=t[i],e.appendChild(o)}}function de(e){n.survey=new se,n.survey.fromJSON(e);const t=document.getElementById("modelSelect");if(A(t,Object.keys(n.survey.config.models)),A(document.getElementById("typeSelect"),n.survey.config.typeList),B.reset(),n.survey.projectedFields.length>0){S.update(n.survey,0);let c=n.survey.projectedFields[0];H(n.survey.config.models[c.model],c.vertices,new E("#abcabc"),c.hotSpot)}else H(n.survey.config.models[t.value],null,new E("#abcabc"));n.survey.config.hideScaleValues&&(document.getElementById("intensityValue").innerHTML="",document.getElementById("naturalnessValue").innerHTML="",document.getElementById("painValue").innerHTML="",document.getElementById("itchValue").innerHTML="");const i=document.getElementById("painDiv");n.survey.config.hidePainSlider?(i.style.display="none",console.log("hiding pain!")):i.style.display="auto";const o=document.getElementById("itchDiv");n.survey.config.hideItchSlider?(o.style.display="none",console.log("hiding itch!")):o.style.display="auto",document.getElementById("restimButton").disabled=!1,w&&re()}function R(e){if(e!=n.currentField){const t=document.getElementById("modelSelect");e.model&&(H(n.survey.config.models[t.value],e.vertices,new E("#abcabc"),e.hotSpot),t.value=e.model);const i=document.getElementById("naturalnessSlider");if(e.naturalness>=0)i.value=e.naturalness,i.dispatchEvent(new Event("input"));else{i.value=5,i.dispatchEvent(new Event("input"));const u=document.getElementById("naturalnessHidden");u.value=e.naturalness}const o=document.getElementById("painSlider");if(e.pain>=0)o.value=e.pain,o.dispatchEvent(new Event("input"));else{o.value=0,o.dispatchEvent(new Event("input"));const u=document.getElementById("painHidden");u.value=e.pain}const c=document.getElementById("itchSlider");if(e.itch>=0)c.value=e.itch,c.dispatchEvent(new Event("input"));else{c.value=0,c.dispatchEvent(new Event("input"));const u=document.getElementById("itchHidden");u.value=e.itch}n.currentField=e}}function j(){const e=l.getNonDefaultVertices(l.currentMesh);n.currentField.vertices=e,l.orbMesh.visible?n.currentField.hotSpot=l.orbPosition:n.currentField.hotSpot={x:null,y:null,z:null};const t=document.getElementById("modelSelect");n.currentField.model=t.value;const i=document.getElementById("naturalnessHidden");n.currentField.naturalness=parseFloat(i.value);const o=document.getElementById("painHidden");n.currentField.pain=parseFloat(o.value);const c=document.getElementById("itchHidden");n.currentField.itch=parseFloat(c.value)}function z(e,t){const i=document.getElementById("smallQualityList");var o=e.qualities.indexOf(t);i.replaceChildren(...S.createQualitiesListChunk(e,o,"",!1).children);const c=document.getElementById("typeSelect");t.type&&(c.value=t.type);var u=document.getElementById("belowSkinCheck");t.depth.includes("belowSkin")?u.checked=!0:u.checked=!1;var d=document.getElementById("atSkinCheck");t.depth.includes("atSkin")?d.checked=!0:d.checked=!1;var s=document.getElementById("aboveSkinCheck");t.depth.includes("aboveSkin")?s.checked=!0:s.checked=!1;const a=document.getElementById("intensitySlider");if(t.intensity>=0)a.value=t.intensity,a.dispatchEvent(new Event("input"));else{a.value=5,a.dispatchEvent(new Event("input"));const f=document.getElementById("intensityHidden");f.value=t.intensity}n.currentField=e,n.currentQuality=t}function V(){const e=document.getElementById("intensityHidden");n.currentQuality.intensity=parseFloat(e.value);const t=document.querySelectorAll('input[name="skinLevelCheckSet"]:checked');n.currentQuality.depth=[];for(let o=0;o<t.length;o++)n.currentQuality.depth.push(t[o].value);const i=document.getElementById("typeSelect");n.currentQuality.type=i.value}function U(){w=setInterval(function(){r.readyState==WebSocket.OPEN&&r.send(JSON.stringify({type:"waiting"}))},1e3),y("waitingTab")}function re(){w=clearInterval(w),y("listTab")}function me(){var e=0;M=setInterval((function(){e==10&&Q(!1),e+=1}).bind(e),500)}function Q(e){if(M=clearInterval(M),e){U(),l.clearMeshStorage();var t=function(){y("waitingTab")};m("Submission was successful!",["Ok"],[t])}else m("Submission failed - please notify the experimenter!",["Ok"],[function(){y("listTab")}]);h(!0)}function ye(){h(!1),document.getElementById("restimButton").disabled=!0;const e=n.validateSurvey();if(e){h(!0);var o=function(){p()};m("Cannot submit survey.<br><br>"+e,["Go Back"],[o])}else{var t=function(){p(),h(!0)},i=function(){const c=n.survey.usedMeshFilenames,u=l.storedMeshNames;var d=[];if(!c.isSubsetOf(u)){const s=c.difference(u);for(let a of s)d.push(l.loadMeshIntoStorage(a))}Promise.all(d).then(function(s){const f={meshes:l.getStoredMeshParameters(c)};n.submitSurveyToServer(r,f)?me():(h(!0),alert("Survey submission failed -- socket is not connected!"))})};m("Are you sure you want to submit this survey?",["No","Yes"],[t,i])}}function W(e){R(e),L()}function D(e){R(e)}function G(e,t){n.currentQuality&&V(),D(e),z(e,t),b()}function pe(e){var t=e.addQuality();const i=document.getElementById("typeSelect");t.type=i.value,G(e,t)}function ve(){n.survey.addField();const e=n.survey.projectedFields,t=e[e.length-1],i=document.getElementById("modelSelect");t.model=i.value;const o=document.getElementById("typeSelect");t.type=o.value,W(t)}function fe(){var e="";l.getNonDefaultVertices(l.currentMesh).size<=0?e="The current projected field is missing a drawing.":l.orbMesh.visible||(e="The current projected field is missing a hot spot."),e?m(e,["Go Back","Continue"],[function(){L()},function(){j(),p()}]):(j(),p())}function ge(){!document.getElementById("belowSkinCheck").checked&&!document.getElementById("atSkinCheck").checked&&!document.getElementById("aboveSkinCheck").checked?m("You must select at least one depth before continuing.",["Go Back"],[function(){b()}]):(V(),p())}function he(){if(!document.getElementById("belowSkinCheck").checked&&!document.getElementById("atSkinCheck").checked&&!document.getElementById("aboveSkinCheck").checked)m("You must select at least one depth before continuing.",["Go Back"],[function(){b()}]);else{V();const e=n.currentField;D(e);const t=e.qualities.indexOf(n.currentQuality),i=e.duplicateQuality(t);n.currentQuality=i,z(e,i),b()}}function q(){p()}function Be(){m("Are you sure you want to delete this projected field?",["No","Yes"],[function(){L()},function(){n.survey.deleteField(n.currentField),n.currentField=null,l.populateColor(l.defaultColor,l.currentMesh),p()}])}function Ee(){m("Are you sure you want to delete this quality?",["No","Yes"],[function(){b()},function(){n.currentField.deleteQuality(n.currentQuality),p()}])}function be(){const e=document.getElementById("modelSelect");H(n.survey.config.models[e.value])}function Se(){const e=document.getElementsByClassName("selectedQuality");for(let t=0;t<e.length;t++)e[t].innerHTML=typeSelect.value.charAt(0).toUpperCase()+typeSelect.value.slice(1)}function Ie(e){e.target.disabled||l.undo()}function ke(e){e.target.disabled||l.redo()}function Ce(e){e.target.disabled||r.send(JSON.stringify({type:"restim"}))}window.onload=function(){l=new ie(document.getElementById("3dContainer"),new E(16777215),new E(4342338),20),B=new le(l.controls,l.renderer.domElement,2,20),B.createZoomSlider(document.getElementById("cameraControlContainer")),B.createCameraReset(document.getElementById("cameraControlContainer")),n=new ae,S=new ce(document.getElementById("fieldListParent"),!0,D,W,G,pe),Y(),U(),ue(O.LEFT,O.TOP);const e=document.getElementById("newFieldButton");e.onpointerup=ve;const t=document.getElementById("submitButton");t.onpointerup=ye;const i=document.getElementById("orbitButton");i.onpointerup=function(){l.toOrbit(),g("orbitButton")};const o=document.getElementById("panButton");o.onpointerup=function(){l.toPan(),g("panButton")};const c=document.getElementById("paintButton");c.onpointerup=function(){l.toPaint(),g("paintButton")};const u=document.getElementById("eraseButton");u.onpointerup=function(){l.toErase(),g("eraseButton")};const d=document.getElementById("hotSpotButton");d.onpointerup=function(){l.toOrbPlace(),g("hotSpotButton")};const s=document.getElementById("brushSizeSlider");s.oninput=function(){document.getElementById("brushSizeValue").innerHTML=(s.value/s.max).toFixed(2),l.brushSize=s.value},s.dispatchEvent(new Event("input"));const a=document.getElementById("fieldDoneButton");a.onpointerup=fe;const f=document.getElementById("fieldCancelButton");f.onpointerup=q;const J=document.getElementById("fieldDeleteButton");J.onpointerup=Be;const Z=document.getElementById("qualifyDoneButton");Z.onpointerup=ge;const _=document.getElementById("qualifyCancelButton");_.onpointerup=q;const K=document.getElementById("qualifyDeleteButton");K.onpointerup=Ee;const X=document.getElementById("qualifyAnotherButton");X.onpointerup=he;const $=document.getElementById("modelSelect");$.onchange=be;const ee=document.getElementById("undoButton");ee.onpointerup=Ie;const te=document.getElementById("redoButton");te.onpointerup=ke;const ne=document.getElementById("restimButton");ne.onpointerup=Ce;const I=document.getElementById("intensitySlider");I.oninput=function(){n.survey&&!n.survey.config.hideScaleValues&&(document.getElementById("intensityValue").innerHTML=I.value);const v=document.getElementById("intensityHidden");v.value=I.value},I.dispatchEvent(new Event("input"));const k=document.getElementById("naturalnessSlider");k.oninput=function(){n.survey&&!n.survey.config.hideScaleValues&&(document.getElementById("naturalnessValue").innerHTML=k.value);const v=document.getElementById("naturalnessHidden");v.value=k.value},k.dispatchEvent(new Event("input"));const C=document.getElementById("painSlider");C.oninput=function(){n.survey&&!n.survey.config.hideScaleValues&&(document.getElementById("painValue").innerHTML=C.value);const v=document.getElementById("painHidden");v.value=C.value},C.dispatchEvent(new Event("input"));const F=document.getElementById("itchSlider");F.oninput=function(){n.survey&&!n.survey.config.hideScaleValues&&(document.getElementById("itchValue").innerHTML=F.value);const v=document.getElementById("itchHidden");v.value=F.value},F.dispatchEvent(new Event("input"));const oe=document.getElementById("typeSelect");oe.oninput=Se,T(!1),l.animate()};
