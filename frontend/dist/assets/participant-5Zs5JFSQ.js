import{S as oe,C as h,a as ie,b as le,p as ue,u as V,c as g,o as y,d as ce,V as P,e as se}from"./common-Cvkf8e95.js";/* empty css                     */document.title="Participant - SensorySurvey3D";var l,n,S,b,F,w,D;const N="/participant-ws";var d;function q(){d=new WebSocket(N),d.onopen=function(){console.log("Socket connected!"),D=setInterval(function(){n.updateSurveyOnServer(d)},1e3)},d.onmessage=function(e){const t=JSON.parse(e.data);switch(t.type){case"survey":ae(t.survey);break;case"submitResponse":t.success?(n.clearSurvey(),S.clear(),l.unloadCurrentMesh(),l.orbMesh.visible=!1,H(t.success)):w?H(t.success):alert("Received submitSuccess without making a submission!");break}},d.onclose=function(){console.log("Connection to websocket @ ",N," closed. Attempting reconnection in 1 second."),clearInterval(D),setTimeout(function(){q()},1e3)},d.onerror=function(e){console.error("Websocket error: ",e.message),d.close()}}function B(e){var o=document.getElementById("sidebar").querySelectorAll("button");for(let i=0;i<o.length;i++)o[i].disabled=!e,e?o[i].style.pointerEvents="auto":o[i].style.pointerEvents="none"}function T(e){document.getElementById("undoButton").disabled=!e,document.getElementById("redoButton").disabled=!e}function m(e,t,o){const i=document.getElementById("alertTab");i.innerHTML="";const u=document.createElement("p");u.style.textAlign="center",u.innerHTML=e;const r=document.createElement("div");for(let a=0;a<t.length;a++){const c=t[a],s=document.createElement("button");s.innerHTML=c,s.onpointerup=o[a],r.appendChild(s)}i.appendChild(u),i.appendChild(r),y("alertTab")}function M(e,t=null,o=null,i=null){l.orbMesh.visible=!1,document.getElementById("modelSelect").disabled=!0,l.replaceCurrentMesh(e,t,o).then((function(){l.orbMesh.visible=!1,b.reset(),document.getElementById("modelSelect").disabled=!1,i&&i.x?(l.orbMesh.position.copy(new P(i.x,i.y,i.z)),l.orbMesh.visible=!0):(l.orbMesh.position.copy(new P(0,0,0)),l.orbMesh.visible=!1)}).bind(i))}function Q(){T(!0),y("fieldTab")}function E(){T(!1),y("qualifyTab")}function p(){document.getElementById("orbitButton").dispatchEvent(new Event("pointerup")),n.survey.renameFields();let e=n.survey.projectedFields.indexOf(n.currentField);S.update(n.survey,e),T(!1),y("listTab")}function x(e,t){e.innerHTML="";for(let o=0;o<t.length;o++){const i=document.createElement("option");i.innerHTML=t[o].charAt(0).toUpperCase()+t[o].slice(1),i.value=t[o],e.appendChild(i)}}function ae(e){n.survey=new ce,n.survey.fromJSON(e);const t=document.getElementById("modelSelect");if(x(t,Object.keys(n.survey.config.models)),x(document.getElementById("typeSelect"),n.survey.config.typeList),b.reset(),n.survey.projectedFields.length>0){S.update(n.survey,0);let o=n.survey.projectedFields[0];M(n.survey.config.models[o.model],o.vertices,new h("#abcabc"),o.hotSpot)}else M(n.survey.config.models[t.value],null,new h("#abcabc"));n.survey.config.hideScaleValues&&(document.getElementById("intensityValue").innerHTML="",document.getElementById("naturalnessValue").innerHTML="",document.getElementById("painValue").innerHTML=""),document.getElementById("restimButton").disabled=!1,F&&de()}function Y(e){if(e!=n.currentField){const t=document.getElementById("modelSelect");e.model&&(M(n.survey.config.models[t.value],e.vertices,new h("#abcabc"),e.hotSpot),t.value=e.model);const o=document.getElementById("naturalnessSlider");if(e.naturalness>=0)o.value=e.naturalness,o.dispatchEvent(new Event("input"));else{o.value=5,o.dispatchEvent(new Event("input"));const u=document.getElementById("naturalnessHidden");u.value=e.naturalness}const i=document.getElementById("painSlider");if(e.pain>=0)i.value=e.pain,i.dispatchEvent(new Event("input"));else{i.value=0,i.dispatchEvent(new Event("input"));const u=document.getElementById("painHidden");u.value=e.pain}n.currentField=e}}function A(){const e=l.getNonDefaultVertices(l.currentMesh);n.currentField.vertices=e,l.orbMesh.visible?n.currentField.hotSpot=l.orbPosition:n.currentField.hotSpot={x:null,y:null,z:null};const t=document.getElementById("modelSelect");n.currentField.model=t.value;const o=document.getElementById("naturalnessHidden");n.currentField.naturalness=parseFloat(o.value);const i=document.getElementById("painHidden");n.currentField.pain=parseFloat(i.value)}function R(e,t){const o=document.getElementById("smallQualityList");var i=e.qualities.indexOf(t);o.replaceChildren(...S.createQualitiesListChunk(e,i,"",!1).children);const u=document.getElementById("typeSelect");t.type&&(u.value=t.type);var r=document.getElementById("belowSkinCheck");t.depth.includes("belowSkin")?r.checked=!0:r.checked=!1;var a=document.getElementById("atSkinCheck");t.depth.includes("atSkin")?a.checked=!0:a.checked=!1;var c=document.getElementById("aboveSkinCheck");t.depth.includes("aboveSkin")?c.checked=!0:c.checked=!1;const s=document.getElementById("intensitySlider");if(t.intensity>=0)s.value=t.intensity,s.dispatchEvent(new Event("input"));else{s.value=5,s.dispatchEvent(new Event("input"));const f=document.getElementById("intensityHidden");f.value=t.intensity}n.currentField=e,n.currentQuality=t}function L(){const e=document.getElementById("intensityHidden");n.currentQuality.intensity=parseFloat(e.value);const t=document.querySelectorAll('input[name="skinLevelCheckSet"]:checked');n.currentQuality.depth=[];for(let i=0;i<t.length;i++)n.currentQuality.depth.push(t[i].value);const o=document.getElementById("typeSelect");n.currentQuality.type=o.value}function z(){F=setInterval(function(){d.readyState==WebSocket.OPEN&&d.send(JSON.stringify({type:"waiting"}))},1e3),y("waitingTab")}function de(){F=clearInterval(F),y("listTab")}function re(){var e=0;w=setInterval((function(){e==10&&H(!1),e+=1}).bind(e),500)}function H(e){if(w=clearInterval(w),e){z(),l.clearMeshStorage();var t=function(){y("waitingTab")};m("Submission was successful!",["Ok"],[t])}else m("Submission failed - please notify the experimenter!",["Ok"],[function(){y("listTab")}]);B(!0)}function me(){B(!1),document.getElementById("restimButton").disabled=!0;const e=n.validateSurvey();if(e){B(!0);var i=function(){p()};m("Cannot submit survey.<br><br>"+e,["Go Back"],[i])}else{var t=function(){p(),B(!0)},o=function(){const u=n.survey.usedMeshFilenames,r=l.storedMeshNames;var a=[];if(!u.isSubsetOf(r)){const c=u.difference(r);for(let s of c)a.push(l.loadMeshIntoStorage(s))}Promise.all(a).then(function(c){const f={meshes:l.getStoredMeshParameters(u)};n.submitSurveyToServer(d,f)?re():(B(!0),alert("Survey submission failed -- socket is not connected!"))})};m("Are you sure you want to submit this survey?",["No","Yes"],[t,o])}}function U(e){Y(e),Q()}function O(e){Y(e)}function W(e,t){n.currentQuality&&L(),O(e),R(e,t),E()}function ye(e){var t=e.addQuality();const o=document.getElementById("typeSelect");t.type=o.value,W(e,t)}function pe(){n.survey.addField();const e=n.survey.projectedFields,t=e[e.length-1],o=document.getElementById("modelSelect");t.model=o.value;const i=document.getElementById("typeSelect");t.type=i.value,U(t)}function fe(){var e="";l.getNonDefaultVertices(l.currentMesh).size<=0?e="The current projected field is missing a drawing.":l.orbMesh.visible||(e="The current projected field is missing a hot spot."),e?m(e,["Go Back","Continue"],[function(){Q()},function(){A(),p()}]):(A(),p())}function ve(){!document.getElementById("belowSkinCheck").checked&&!document.getElementById("atSkinCheck").checked&&!document.getElementById("aboveSkinCheck").checked?m("You must select at least one depth before continuing.",["Go Back"],[function(){E()}]):(L(),p())}function ge(){if(!document.getElementById("belowSkinCheck").checked&&!document.getElementById("atSkinCheck").checked&&!document.getElementById("aboveSkinCheck").checked)m("You must select at least one depth before continuing.",["Go Back"],[function(){E()}]);else{L();const e=n.currentField;O(e);const t=e.qualities.indexOf(n.currentQuality),o=e.duplicateQuality(t);n.currentQuality=o,R(e,o),E()}}function j(){p()}function Be(){m("Are you sure you want to delete this projected field?",["No","Yes"],[function(){Q()},function(){n.survey.deleteField(n.currentField),n.currentField=null,l.populateColor(l.defaultColor,l.currentMesh),p()}])}function be(){m("Are you sure you want to delete this quality?",["No","Yes"],[function(){E()},function(){n.currentField.deleteQuality(n.currentQuality),p()}])}function he(){const e=document.getElementById("modelSelect");M(n.survey.config.models[e.value])}function Ee(){const e=document.getElementsByClassName("selectedQuality");for(let t=0;t<e.length;t++)e[t].innerHTML=typeSelect.value.charAt(0).toUpperCase()+typeSelect.value.slice(1)}function Se(e){e.target.disabled||l.undo()}function Ie(e){e.target.disabled||l.redo()}function ke(e){e.target.disabled||d.send(JSON.stringify({type:"restim"}))}window.onload=function(){l=new oe(document.getElementById("3dContainer"),new h(16777215),new h(4342338),20),b=new ie(l.controls,l.renderer.domElement,2,20),b.createZoomSlider(document.getElementById("cameraControlContainer")),b.createCameraReset(document.getElementById("cameraControlContainer")),n=new se,S=new le(document.getElementById("fieldListParent"),!0,O,U,W,ye),q(),z(),ue(V.LEFT,V.TOP);const e=document.getElementById("newFieldButton");e.onpointerup=pe;const t=document.getElementById("submitButton");t.onpointerup=me;const o=document.getElementById("orbitButton");o.onpointerup=function(){l.toOrbit(),g("orbitButton")};const i=document.getElementById("panButton");i.onpointerup=function(){l.toPan(),g("panButton")};const u=document.getElementById("paintButton");u.onpointerup=function(){l.toPaint(),g("paintButton")};const r=document.getElementById("eraseButton");r.onpointerup=function(){l.toErase(),g("eraseButton")};const a=document.getElementById("hotSpotButton");a.onpointerup=function(){l.toOrbPlace(),g("hotSpotButton")};const c=document.getElementById("brushSizeSlider");c.oninput=function(){document.getElementById("brushSizeValue").innerHTML=(c.value/c.max).toFixed(2),l.brushSize=c.value},c.dispatchEvent(new Event("input"));const s=document.getElementById("fieldDoneButton");s.onpointerup=fe;const f=document.getElementById("fieldCancelButton");f.onpointerup=j;const G=document.getElementById("fieldDeleteButton");G.onpointerup=Be;const J=document.getElementById("qualifyDoneButton");J.onpointerup=ve;const Z=document.getElementById("qualifyCancelButton");Z.onpointerup=j;const _=document.getElementById("qualifyDeleteButton");_.onpointerup=be;const K=document.getElementById("qualifyAnotherButton");K.onpointerup=ge;const X=document.getElementById("modelSelect");X.onchange=he;const $=document.getElementById("undoButton");$.onpointerup=Se;const ee=document.getElementById("redoButton");ee.onpointerup=Ie;const te=document.getElementById("restimButton");te.onpointerup=ke;const I=document.getElementById("intensitySlider");I.oninput=function(){n.survey&&!n.survey.config.hideScaleValues&&(document.getElementById("intensityValue").innerHTML=I.value);const v=document.getElementById("intensityHidden");v.value=I.value},I.dispatchEvent(new Event("input"));const k=document.getElementById("naturalnessSlider");k.oninput=function(){n.survey&&!n.survey.config.hideScaleValues&&(document.getElementById("naturalnessValue").innerHTML=k.value);const v=document.getElementById("naturalnessHidden");v.value=k.value},k.dispatchEvent(new Event("input"));const C=document.getElementById("painSlider");C.oninput=function(){n.survey&&!n.survey.config.hideScaleValues&&(document.getElementById("painValue").innerHTML=C.value);const v=document.getElementById("painHidden");v.value=C.value},C.dispatchEvent(new Event("input"));const ne=document.getElementById("typeSelect");ne.oninput=Ee,T(!1),l.animate()};
